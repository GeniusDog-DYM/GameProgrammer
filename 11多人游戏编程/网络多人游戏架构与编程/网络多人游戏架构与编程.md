# 作者简介

Joshua Glazer, 独立的游戏开发工作室，为 UE， LOL，EA，微软等公司提供咨询，USC 兼职讲师

Sanjay Madhav，南加州大学 USC 高级讲师，在 EA 开发过《荣誉勋章：血战太平洋》等游戏

# 前言

1. 互联网是如何工作的，如何将数据发送给其它计算机。
2. 如何准备用于网络传输的游戏数据，如何更新网络中的游戏对象，如何组织参与游戏的计算机。
3. 如何补偿不可靠性和网络延迟，如何将游戏代码设计得同时具有可扩展性和安全性。
4. 如何集成玩家服务，使用云服务器

# 第1章 网络游戏概述

## 问题
1. 本地多人游戏和网络游戏最大的区别？
   * 有两台或更多的计算机在一个活动的游戏中彼此连接。
2. 本地多人游戏的 3 种不同类型？
   * 串口，电话线调制解调器，以太网
3. 将网络游戏的运行从局域网切换到互联网主要考虑是什么？
   * 延迟，数据在网络中的传输时间。延迟补偿的方法
4. MUD 是什么？发展为什么类型的游戏？
   * 多用户网络游戏，《龙与地下城》，运行于 BBS。发展成为图形化改进的 MMO
5. MMO 与标准在线游戏的区别是什么？
   * 在线人数，标准的 4 ~ 32，MMO 成百上千。
6. 在《星际围攻：部落》中，哪个系统来提供可靠性？
   *  事件管理器
7. 描述以下，当数据包丢失时，《星际围攻：部落》网络模型中 ghost 管理器如何重建最小必要的传输。
   * 首先依据状态变换据欸的那个，其次由优先级决定。
8. 《帝国时代》的点对点模型中，轮班计时器的目的是什么？每个节点传送什么信息到其它节点。
   * 解决等待执行命令时间过长，看起来响应十分缓慢的问题。传输一个轮班时间内的命令队列。 

## 1. 多人游戏的简要历程

1. 本地多人游戏，和单机游戏没啥区别，《双人网球》
2. 早期网络多人游戏，大型机组成的小网络。
3. 多用户网络游戏，MUD，运行于 BBS
4. 局域网游戏，LAN，《DOOM》。串口，以太网
5. 在线游戏，《雷神之锤》《虚幻》
6. 大规模多人在线游戏，MMO
7. 移动网络游戏，可靠性低采用异步通信模型游戏，随着 wifi 普及，实时网络游戏《炉石》

## 2. 星际部落围攻

1998年，FPS，128 个玩家，电话线拨号上网。本书游戏案例（robo Cat Action）
* 数据 4 种类型
  * 非保障数据，首先丢弃
  * 保障数据，保证准确的到达顺序
  * 最近的状态数据，最新版本的才是重要
  * 最快保障数据，最高优先级，在可靠的基础上保证尽快到达sha


![](Media/网络多人游戏架构与编程/2020-07-09-00-38-47.png)

1. 平台数据包模块，最底层针对特定平台，对标准套接字的封装。**不可靠**
2. 连接管理器，从上层流管理器接收数据，给底层平台数据包模块。仅保证投递状态，使用滑动窗口种接收域的位字段实现**不可靠**
3. 流管理器，决定允许数据传输的最大速率，根据网络连接的质量有所不同。把请求按照优先次序排好，分派给连接管理器，高层通过流管理器的投递状态得到通知。
4. 事件管理器，远程过程调用 RPC，玩家发起攻击事件，事件被发送到事件管理器，接着发送到服务器，服务器确认和执行攻击。
    * **`可靠`**，事件管理器追踪所有被标记为可靠的传输记录， 如果可靠记录没有被确认，会再次将事件放入队列，重新传输一次。
5. ghost 管理器，复制与指定客户端相关的动态对象。“必须知道”，“最好知道”，优先级不同。当一个对象成为**相关对象（在范围内）**，ghost 管理器给该对象赋予一些信息，称为 ghost 记录。
   * 游戏模拟层决定客户端必须知道什么，最好知道什么。保证最最近的数据总是能成功地传输到所有的客户端。
6. 移动管理器，尽快传输玩家的移动数据。
7. 其它系统，例如数据库管理器处理静态的游戏对象的传输，炮台。

## 3. 帝国时代

* 确定性锁步（deterministic lockstep）网络模型。P2P 对等网络，本书案例 RoboCat RTS

1. 轮班计时器
   * 问题：
     * 不同玩家帧率，网络连接质量不同。玩家 A 发出攻击执行命令，要通知每一个游戏实例，等待时间过长，看起来响应相当迟缓。
   * 解决方法《帝国时代》，轮班长度默认 200ms
     * 200ms 之内的所有命令存储在一个缓冲区内，轮班结束时，将所有命令通过网络传输给其它玩家。
     * 两个轮班之间的执行延迟，50轮发出的命令，52轮执行，延迟高达 600 ms
   * 《星际2》也在用
   * 边界情况，滞后尖峰导致所有玩家跟不上 200 ms 计时器，停止模拟，强行退出，试图基于网络情况动态调整渲染帧的方法来弥补。
   * 方便录制比赛命令，然后重播。
2. 同步
   * 伪随机数生成器，PRNG。每个游戏实例不仅使用的种子是一样的，而且使用次数也是一样的。
   * 减少了作弊的机会。
  

# 第2章 互联网

# 第3章 伯克利套接字

# 第4章 对象序列化

# 第5章 对象复制

# 第6章 网络拓扑和游戏案例

# 第7章 延迟、抖动和可靠性

# 第8章 改进得延迟处理

# 第9章 可扩展性

# 第10章 安全性

# 第11章 真实世界得引擎

# 第12章 玩家服务

# 第13章 云托管专用服务器