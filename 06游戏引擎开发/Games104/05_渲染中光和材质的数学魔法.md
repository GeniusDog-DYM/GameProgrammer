![image-20220417163400367](Media/05_渲染中光和材质的数学魔法/image-20220417163400367.png)



硬核的知识讲不了太深，讲故事，梳理发展历程



# 渲染方程及挑战

![image-20220417163657964](Media/05_渲染中光和材质的数学魔法/image-20220417163657964.png)

![image-20220417234634611](Media/05_渲染中光和材质的数学魔法/image-20220417234634611.png)

![image-20220417234901938](Media/05_渲染中光和材质的数学魔法/image-20220417234901938.png)

35 年前给了一条理论方程，各种 BRDF 实现，又爱又恨

![image-20220417235140281](Media/05_渲染中光和材质的数学魔法/image-20220417235140281.png)

![image-20220417235230541](Media/05_渲染中光和材质的数学魔法/image-20220417235230541.png)

![image-20220417235421721](Media/05_渲染中光和材质的数学魔法/image-20220417235421721.png)

![image-20220417235508965](Media/05_渲染中光和材质的数学魔法/image-20220417235508965.png)

作者感觉最痛苦的 3 点总结，一家之言

![image-20220417235628142](Media/05_渲染中光和材质的数学魔法/image-20220417235628142.png)



# 基础光照解决方案

![image-20220417235924908](Media/05_渲染中光和材质的数学魔法/image-20220417235924908.png)

![image-20220418000102738](Media/05_渲染中光和材质的数学魔法/image-20220418000102738.png)

![image-20220418000119869](Media/05_渲染中光和材质的数学魔法/image-20220418000119869.png)

BRDF 的发展历程百花齐放，最前沿的已经到了波动理论，光会互相干涉

作者更加喜欢经验派的模型

光可叠加性

![image-20220418000239113](Media/05_渲染中光和材质的数学魔法/image-20220418000239113.png)

![image-20220418000617853](Media/05_渲染中光和材质的数学魔法/image-20220418000617853.png)

![image-20220418000911262](Media/05_渲染中光和材质的数学魔法/image-20220418000911262.png)

![image-20220418001026139](Media/05_渲染中光和材质的数学魔法/image-20220418001026139.png)

![image-20220418001151820](Media/05_渲染中光和材质的数学魔法/image-20220418001151820.png)

![image-20220418001407854](Media/05_渲染中光和材质的数学魔法/image-20220418001407854.png)

* No.1a Visibility to Lights
* No.1b Light Source Complexity
* No.2 How to do Integral Efficiently on Hardware
* No.3 Any matter will be light source



# 基于预计算的全局光照

3A 给自己找麻烦，放着传统的 3 件套不用，3A 的文化要搞出新花样 

2003 ~ 2004 突飞猛进

![image-20220418002002089](Media/05_渲染中光和材质的数学魔法/image-20220418002002089.png)

![image-20220418002036899](Media/05_渲染中光和材质的数学魔法/image-20220418002036899.png)

![image-20220418002047410](Media/05_渲染中光和材质的数学魔法/image-20220418002047410.png)

## Pre-computed Global Illumination

空间换时间

全局光照

![image-20220418002242400](Media/05_渲染中光和材质的数学魔法/image-20220418002242400.png)

![image-20220418002416689](Media/05_渲染中光和材质的数学魔法/image-20220418002416689.png)

比起对所有采样点进行加权平均，傅里叶变换到频域，卷积运算效率会大大提升

![image-20220418002930447](Media/05_渲染中光和材质的数学魔法/image-20220418002930447.png)

球谐函数

![image-20220418002953878](Media/05_渲染中光和材质的数学魔法/image-20220418002953878.png)

![image-20220418003201653](Media/05_渲染中光和材质的数学魔法/image-20220418003201653.png)

![image-20220418003335765](Media/05_渲染中光和材质的数学魔法/image-20220418003335765.png)

![image-20220418003429051](Media/05_渲染中光和材质的数学魔法/image-20220418003429051.png)

![image-20220418003436006](Media/05_渲染中光和材质的数学魔法/image-20220418003436006.png)

二阶连续，用几个参数就能还原出大概的光强信息

![image-20220418003525137](Media/05_渲染中光和材质的数学魔法/image-20220418003525137.png)

EA. (2018). Precomputed Global Illumination in Frostbite. Retrieved from https://www.ea.com/frostbite/news/precomputed-global-illumination-in-frostbite



## Light Map

![image-20220418003817968](Media/05_渲染中光和材质的数学魔法/image-20220418003817968.png)

卡马克之前算 Shader 算不过来，就已经提前采用预计算了

把整个场景的光照烘焙到一张图上

![image-20220418004014419](Media/05_渲染中光和材质的数学魔法/image-20220418004014419.png)

参数化展开均衡还挺复杂的，DX 当年还专门开发了 API 来做这个事情

![image-20220418004237395](Media/05_渲染中光和材质的数学魔法/image-20220418004237395.png)

烘焙出的效果很好，但是开发效率很低

![image-20220418005137090](Media/05_渲染中光和材质的数学魔法/image-20220418005137090.png)

![image-20220418005147215](Media/05_渲染中光和材质的数学魔法/image-20220418005147215.png)

![image-20220418005205048](Media/05_渲染中光和材质的数学魔法/image-20220418005205048.png)

Light Map 以后可能会被淘汰掉，但是思想很重要

* 空间换时间

* 把个整个游戏场景参数化到一个二维或者三维的贴图上



## Light Probe

![image-20220418005722978](Media/05_渲染中光和材质的数学魔法/image-20220418005722978.png)

自动化生成

![image-20220418005902954](Media/05_渲染中光和材质的数学魔法/image-20220418005902954.png)

光照是低频信息，可以采样精度很低，但要摆的密集

反射是高频信息，需要高精度，密度会低

![image-20220418010111187](Media/05_渲染中光和材质的数学魔法/image-20220418010111187.png)

![image-20220418010127304](Media/05_渲染中光和材质的数学魔法/image-20220418010127304.png)

可以处理动态物体，根据帧率情况延迟处理变化。效果比 Light Map 要差一些（软阴影，重叠等等）



# 基于物理的材质 Physical-Based Material

微平面理论

![image-20220418010552140](Media/05_渲染中光和材质的数学魔法/image-20220418010552140.png)

![image-20220418010647474](Media/05_渲染中光和材质的数学魔法/image-20220418010647474.png)

备注：闫老师 diss 过这种写法，把 diffuse 拆出来非常错误

![image-20220423233357727](Media/05_渲染中光和材质的数学魔法/image-20220423233357727.png)

GGX 高频更尖，低频更下沉。就像好音响的标准

实时渲染核心，大胆假设，看起来对就行，高性能的近似

![image-20220423233758162](Media/05_渲染中光和材质的数学魔法/image-20220423233758162.png)

G 代表自遮挡

巧妙在，只要设置 roughness 就能得到 D 和 G 两个结果

![image-20220423234045990](Media/05_渲染中光和材质的数学魔法/image-20220423234045990.png)

很著名的 5 次方，大牛数学推导

![image-20220423234318791](Media/05_渲染中光和材质的数学魔法/image-20220423234318791.png)

## Disney Principled BRDF

![image-20220423234458754](Media/05_渲染中光和材质的数学魔法/image-20220423234458754.png)

动画电影的信条，跟游戏引擎高度重合。前面的 Cook Torrance 模型艺术家很容易调出问题，各种匪夷所思的 Bug

* 每个参数必须要符合艺术家的直觉
* 尽可能少的参数
* 所有参数的范围最好是 0 ~ 1
* 特殊情况可以超过这个范围，但必须要出现有意思的结果
* 这些参数的组合，不会产生很诡异的结果，出现的结果基本都是有意义的

把痛苦和悲伤留给自己，把快乐给艺术家和策划

![image-20220423235052662](Media/05_渲染中光和材质的数学魔法/image-20220423235052662.png)

迪士尼是离线渲染，实时渲染在后面追赶

## 实时渲染常用的 2 种模型

![image-20220423235242896](Media/05_渲染中光和材质的数学魔法/image-20220423235242896.png)

![image-20220423235403491](Media/05_渲染中光和材质的数学魔法/image-20220423235403491.png)

直接用图像素级控制，不需要填参数。

问题：太灵活，Specular 一旦设置不好菲涅尔就炸掉了

改进为 MR 模型

![image-20220423235720998](Media/05_渲染中光和材质的数学魔法/image-20220423235720998.png)

金属度这个值，如果值很低就是非金属，颜色就不能进入到 Diffuse 的 Specular 那个反射项里面去。如果是金属，BaseColor 就会被大量抽走，放到菲涅尔项里面去。

![image-20220423235956189](Media/05_渲染中光和材质的数学魔法/image-20220423235956189.png)

MR 模型可以理解为把 SG 包装了一层，变成了小白操作界面。

金属和非金属过度的时候，会产生白边，还没有太好的解决方案。

![image-20220424000236727](Media/05_渲染中光和材质的数学魔法/image-20220424000236727.png)

# Image-Based Lighting (IBL) 基于图像的算法

![image-20220424000328713](Media/05_渲染中光和材质的数学魔法/image-20220424000328713.png)

如果能提前对真实的光照进行预处理，就可以快速把光照对材质的卷积运算算出来。球谐函数的还原还是太粗糙了，达不到凹凸感细节感。

![image-20220424000540950](Media/05_渲染中光和材质的数学魔法/image-20220424000540950.png)

![image-20220424000615859](Media/05_渲染中光和材质的数学魔法/image-20220424000615859.png)

提前算好，空间换时间。查表提高速度

![image-20220424000803644](Media/05_渲染中光和材质的数学魔法/image-20220424000803644.png)

![image-20220424000847722](Media/05_渲染中光和材质的数学魔法/image-20220424000847722.png)

![image-20220424000900428](Media/05_渲染中光和材质的数学魔法/image-20220424000900428.png)

![image-20220424001018860](Media/05_渲染中光和材质的数学魔法/image-20220424001018860.png)

![image-20220424001100371](Media/05_渲染中光和材质的数学魔法/image-20220424001100371.png)

# Classic Shadow Solution 经典阴影的方法

![image-20220424001214760](Media/05_渲染中光和材质的数学魔法/image-20220424001214760.png)

![image-20220424001250243](Media/05_渲染中光和材质的数学魔法/image-20220424001250243.png)

经典挑战，hack 黑魔法套路

![image-20220424001423529](Media/05_渲染中光和材质的数学魔法/image-20220424001423529.png)

![image-20220424001509798](Media/05_渲染中光和材质的数学魔法/image-20220424001509798.png)

是游戏里面最贵的独立的 Part，30ms 里面 Shadow 很多时候会吃掉 4 ~ 5 ms。场景要绘制 4 次，要做 4 次裁剪，很难做到 2ms 以内。

![image-20220424001946514](Media/05_渲染中光和材质的数学魔法/image-20220424001946514.png)

![image-20220424002001349](Media/05_渲染中光和材质的数学魔法/image-20220424002001349.png)

![image-20220424002013661](Media/05_渲染中光和材质的数学魔法/image-20220424002013661.png)

很多引擎标配 PCSS

![image-20220424002216165](Media/05_渲染中光和材质的数学魔法/image-20220424002216165.png)

VSSM，Variance Soft Shadow Map 很多项目用了，实战效果很香。



# AAA Rendering 总结

![image-20220424002334085](Media/05_渲染中光和材质的数学魔法/image-20220424002334085.png)

搞定这些，可以写一个 5 ~10 年前的 3A 游戏引擎了。出来找工作没啥大难题了



# 前沿技术 Moving Wave of High Quality

硬件的发展彻底颠覆了渲染的底层逻辑

![image-20220424002626818](Media/05_渲染中光和材质的数学魔法/image-20220424002626818.png)

实时光追

![image-20220424002741565](Media/05_渲染中光和材质的数学魔法/image-20220424002741565.png)

![image-20220424002834907](Media/05_渲染中光和材质的数学魔法/image-20220424002834907.png)

游戏画面，有了质的飞跃。

![image-20220424003041498](Media/05_渲染中光和材质的数学魔法/image-20220424003041498.png)

![image-20220424003125161](Media/05_渲染中光和材质的数学魔法/image-20220424003125161.png)



# Shader 管理

![image-20220424003321539](Media/05_渲染中光和材质的数学魔法/image-20220424003321539.png)

![image-20220424003333118](Media/05_渲染中光和材质的数学魔法/image-20220424003333118.png)

![image-20220424003351027](Media/05_渲染中光和材质的数学魔法/image-20220424003351027.png)

![image-20220424003402630](Media/05_渲染中光和材质的数学魔法/image-20220424003402630.png)

GPU 不喜欢分支，容易浪费并行的效率

![image-20220424003432276](Media/05_渲染中光和材质的数学魔法/image-20220424003432276.png)

![image-20220424003558959](Media/05_渲染中光和材质的数学魔法/image-20220424003558959.png)



# Q&A

## GI 未来会如何发展

随着硬件的发展，未来 5 年会彻底解决掉。

## 云渲染能不能解决 Kajiya 的问题

如果采取端云协同的话，说不定还真能解决。有些计算是 Real 依赖观察者的，有些计算是跟 View 没有关系的。

## 游戏里面动态日夜怎么解决光照的问题？

TOD time of day，不同纬度还不一样。这节课不讲，跟天空大气有关，中午和月光的光照流明差几万倍，PBR 材质是否支持这么大的宽容度？IBL，环境光的比重变高